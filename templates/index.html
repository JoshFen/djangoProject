<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <style>
      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
        background-color: cadetblue;
        font-family: Lato, Arial;
      }

      #layout{
          display: grid;
          grid-template-areas: "map title"
                               "map title"
                               "map title"
                               "map title";
          grid-template-columns: 80% 1fr;
      }

      #search{
          grid-area: title;
          display: grid;
          grid-template-areas: "heading"
                               "from-loc"
                               "destination"
                               "go-button";
          grid-template-rows: 50px 40px 40px 1fr;
          grid-gap: 20px;
          text-transform: uppercase;
      }

      #map {
        /* configure the size of the map */
        width: 100%;
        height: 100%;
        border: black 10px;
        grid-area: map;
      }



      #route-mapper{
          text-align: center;
          grid-area: heading;
      }

      #from{
          grid-area: from-loc;
      }

      #to{
          grid-area: destination;
      }

      .input {
          margin-left: 10px;
          margin-right: 10px;
          text-transform: uppercase;
          font-family: Lato, Arial;
      }

      #submit{
          grid-area: go-button;
          display: inline-block;
          text-align: center;
          width: 200px;
          height: 50px;
          margin-left: 25%;
      }

    </style>
  </head>

  {% block content %}
  <body id="layout">
    <div id="search">
        <h2 id="route-mapper">Route Mapper</h2>

        <select class="input" id="from">
            {% for node in ways %}
                <option value="{{ node }}"> {{node}} </option>
            {% endfor %}
        </select>
        <select class="input" id="to">
            {% for node in ways %}
                <option value="{{ node }}"> {{node}} </option>
            {% endfor %}
        </select>

        {% csrf_token %}
        <button id="submit" type="button">GO</button>
    </div>
    <div id="map"></div>
    <script>
      // initialize Leaflet
      var map = L.map('map').setView({lon: -75.5183, lat: 40.8153}, 16);

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // add the OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        minZoom: 16,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(map);

      // show the scale bar on the lower left corner
      L.control.scale({imperial: true, metric: true}).addTo(map);

      var btn = document.getElementById("submit");
      btn.addEventListener('click', route);

      function route(){
          var select = document.getElementById("from");
          var start = select.options[select.selectedIndex].value;
          var select1 = document.getElementById("to");
          var end = select1.options[select1.selectedIndex].value;
          console.log(start);
          console.log(end);


          $(document).ready(function () {
          var points = [start, end]
          var dataJ = JSON.stringify(points)
          $.ajax({
                headers: {'X-CSRFTOKEN': csrftoken},
                type: 'POST',
                url: '/handle_request/',
                data: {data: dataJ},
                cache: false,
                success: function (data) {
                    console.log("success")
                },
                error: function(data) {
                    console.log("here");

                }
            });// Close ajax post

          $.ajax({
              url: '/handle_request/',
              type: "GET",
              dataType: "json",
              cache: false,
              success: (data) => {
                console.log("here", data['route']);
                let plots = data['route']
                L.polyline(plots, {color: 'blue'}).addTo(map);

              },
              error: (error) => {
                console.log(error);
              }
            }); // Close ajax get
          }); // Close document function
      } // end of route

    </script>
  </body>
{% endblock content %}
</html>